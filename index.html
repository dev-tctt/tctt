<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tra c·ª©u th√¥ng tin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #e0f2fe; --bg-2: #f0f9ff; --card: #ffffff; --border: #bae6fd;
      --text: #0f172a; --muted: #334155; --primary: #0ea5e9; --primary-dark: #0284c7;
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --neutral: #64748b;
    }
    body { font-family: system-ui, Arial, sans-serif; background: linear-gradient(180deg, var(--bg), var(--bg-2)); color: var(--text); padding: 16px; margin: 0; }
    .wrap { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: 0 6px 20px rgba(2,132,199,.1); padding: 20px; min-height: calc(100vh - 32px); }
    h2 { margin: 0 0 4px; font-size: 26px; color: var(--primary-dark); font-weight: 800; letter-spacing: .5px; user-select: none; }
    .topbar{
      display:grid;
      grid-template-columns: 1fr auto 1fr; /* left spacer | title | lock buttons */
      align-items:center;
      margin-bottom:8px;
    }
    .topbar h2{ grid-column: 2; justify-self: center; text-align:center; }
    .lock{ grid-column: 3; justify-self:end; display:inline-flex; gap:8px; align-items:center; background:#f1f5f9; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:13px; color:#334155;}
    .lock .btn{height:28px;width:34px;padding:0;border-radius:999px}
    .lock .btn[disabled]{opacity:.5;cursor:not-allowed}
    .grid { display: grid; grid-template-columns: 2fr 2fr 1.5fr 1.5fr auto auto; gap: 10px; align-items:center; margin-bottom:8px; }
    @media (max-width: 1200px) { .grid { grid-template-columns: 1fr; } }
    input, textarea { padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-2); color: var(--text); outline: none; resize: none; }
    input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14,165,233,.2); background: #fff; }
    button { border: none; border-radius: 10px; font-weight: 700; cursor: pointer; display:inline-flex; align-items:center; justify-content:center; height:36px; }
    .btn { padding: 0 12px; font-size: 14px; line-height: 1.2; }
    .add { background: var(--success); color: #fff; }
    .update { background: var(--primary); color: #fff; }
    .wipe { background: var(--neutral); color:#fff; }
    .delete-all { background: var(--danger); color:#fff; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin:14px 0 4px; }
    .export { background: var(--primary); color:#fff; } .template { background:#8b5cf6; color:#fff; }
    .searchbox { display:flex; gap:10px; align-items:center; background: var(--bg-2); padding:10px; border:1px solid var(--border); border-radius:12px; margin-top:10px;}
    .searchbox label { font-weight:700; color:var(--muted); }
    table { width:100%; border-collapse:collapse; margin-top:10px; background:#fff; table-layout:fixed; position: relative; }
    th,td { border:1px solid var(--border); padding:10px; text-align:left; vertical-align:top; }
    th { background:#f0f9ff; color:#627080; position: relative; user-select: none; }
    tr:nth-child(even){background:#f8fdff;}
    table th:nth-child(1),table td:nth-child(1){text-align:center;}
    .actions{display:flex;gap:8px;} .edit{background:var(--neutral);color:#fff;font-size:14px;padding:6px 10px;border-radius:8px;} .del{background:var(--danger);color:#fff;font-size:14px;padding:6px 10px;border-radius:8px;}
    .locked-actions .edit,.locked-actions .del{opacity:.35; pointer-events:none;}
    .cam,.book{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:8px;border:1px solid var(--border);font-size:18px;text-decoration:none;}
    .cam{background:#e0f2fe;} .cam:hover{background:#dbeafe;}
    .book{background:#ecfccb;} .book:hover{background:#dcfce7;}
    .meta{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:10px;color:var(--muted);font-size:13px;}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#e2e8f0;color:#0f172a;}
    .danger{background:#fee2e2;color:#991b1b;}
    .col-resizer{ position:absolute; top:0; right:-4px; width:8px; height:100%; cursor: col-resize; user-select:none; }
    th.locked .col-resizer{ display:none; } th.locked{ cursor: default !important; }
    /* Usage row */
    .usage-wrap{
      display:grid;
      grid-template-columns: 1fr auto 80px;
      grid-template-areas: "label expand count" "area area area";
      gap:10px;
      align-items:center;
      margin-top:8px;
    }
    .usage-label{grid-area:label; font-weight:700; color:var(--muted); display:flex; align-items:center;}
    .usage-counter{grid-area:count; font-size:12px; color:var(--muted); text-align:right;}
    .usage-expand{grid-area:expand; justify-self:end;}
    #usage{grid-area:area;}
    /* Ghi ch√∫ link row */
    .note-link{ display:grid; grid-template-columns: 1fr; gap:8px; margin-top:8px; }
    label.file{ display:inline-flex; align-items:center; gap:8px; background: var(--warning); color:#111827; padding:7px 12px; border-radius:10px; cursor:pointer; font-weight:700; }
    label.file input{ display:none; }
    /* Improved wrapping for long words and keep line breaks */
    .preline{
      white-space: pre-line;
      overflow-wrap: anywhere;
      word-break: break-word;
      word-wrap: break-word;
    }
    /* Modal */
    .modal{ position: fixed; inset: 0; background: rgba(15, 23, 42, .5); display:none; align-items:center; justify-content:center; padding:16px; z-index: 99; }
    .modal.show{ display:flex; }
    .dialog{ width: min(900px, 95vw); background:#fff; border-radius:14px; border:1px solid var(--border); box-shadow:0 8px 30px rgba(15,23,42,.2); overflow:hidden; }
    .dialog header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; background:#f8fbff; border-bottom:1px solid var(--border); font-weight:800; color:#0ea5e9; }
    .dialog main{ padding:14px; }
    .dialog footer{ display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; background:#f8fbff; border-top:1px solid var(--border); }
    .dialog textarea{ width:100%; min-height:320px; max-height:60vh; resize:vertical; }
    .btn.gray{ background:#e2e8f0; color:#0f172a; }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#f1f5f9; border:1px solid #e2e8f0; border-bottom-width:2px; padding:2px 6px; border-radius:6px; font-size:12px; }
    .shortcut{font-size:12px;color:#64748b;}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h2 id="title">Tra c·ª©u th√¥ng tin</h2>
    <div class="lock" id="lockBox">
      <button class="btn gray" id="unlockBtn" onclick="unlock()" title="M·ªü kh√≥a">üîê</button>
      <button class="btn gray" id="lockBtn" onclick="lock()" title="Kh√≥a">üîí</button>
    </div>
  </div>

  <div class="grid">
    <input id="imgUrl" type="url" placeholder="Link h√¨nh ·∫£nh (t√πy ch·ªçn)" />
    <input id="program" type="text" placeholder="T√™n ch∆∞∆°ng tr√¨nh" />
    <input id="denom" type="text" placeholder="M·ªánh gi√°" />
    <input id="symbol" type="text" placeholder="Quy ∆∞·ªõc k√Ω hi·ªáu" />
    <button id="addBtn" class="btn add" onclick="addItem()" title="Th√™m">Th√™m</button>
    <button class="btn wipe" onclick="resetForm()">X√≥a form</button>
  </div>

  <div class="usage-wrap">
    <label for="usage" class="usage-label">C√°ch d√πng</label>
    <button class="btn gray usage-expand" onclick="openEditor('usage')" title="M·ªü r·ªông C√°ch d√πng (Ctrl+Shift+U)">M·ªü r·ªông</button>
    <div class="usage-counter"><span id="usageCount">0</span> k√Ω t·ª±</div>
    <textarea id="usage" rows="3" placeholder="Nh·∫≠p h∆∞·ªõng d·∫´n/c√°ch d√πng chi ti·∫øt..."></textarea>
  </div>

  <!-- Ghi ch√∫: ch·ªâ nh·∫≠p link, kh√¥ng c√≤n popup -->
  <div class="note-link">
    <input id="note" type="url" placeholder="Ghi ch√∫: d√°n link (s·∫Ω hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng üìñ trong b·∫£ng)" />
  </div>

  <div class="row">
    <button class="btn export" onclick="exportExcel()">Xu·∫•t Excel (.xlsx)</button>
    <label class="file">Nh·∫≠p Excel<input id="importXLSX" type="file" accept=".xlsx,.xls" onchange="importExcel(event)" /></label>
    <button class="btn template" onclick="downloadExcelTemplate()">T·∫£i file m·∫´u Excel</button>
    <button class="btn delete-all" onclick="onClearAll()" title="X√≥a t·∫•t c·∫£ (c·∫ßn m·ªü kh√≥a)">X√≥a t·∫•t c·∫£</button>
  </div>

  <div class="searchbox">
    <label for="search">üîé T√¨m ki·∫øm</label>
    <input id="search" type="search" placeholder="L·ªçc theo t√™n/m·ªánh gi√°/k√Ω hi·ªáu/c√°ch d√πng/ghi ch√∫..." oninput="onSearchInput(this.value)" />
  </div>

  <table id="mainTable">
    <colgroup id="cg">
      <col style="width:40px"><!-- STT locked -->
      <col style="width:100px"><!-- H√¨nh ·∫£nh -->
      <col style="width:180px"><!-- T√™n CT -->
      <col style="width:120px"><!-- M·ªánh gi√° -->
      <col style="width:120px"><!-- K√Ω hi·ªáu -->
      <col style="width:220px"><!-- C√°ch d√πng -->
      <col style="width:120px"><!-- Ghi ch√∫ (icon/text) -->
      <col style="width:120px"><!-- H√†nh ƒë·ªông -->
    </colgroup>
    <thead>
      <tr>
        <th class="locked">STT</th>
        <th>H√¨nh ·∫£nh</th>
        <th>T√™n CT</th>
        <th>M·ªánh gi√°</th>
        <th>K√Ω hi·ªáu</th>
        <th>C√°ch d√πng</th>
        <th>Ghi ch√∫</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="meta">
    <div id="countInfo">Hi·ªÉn th·ªã 0 m·ª•c</div>
    <div>
      <!-- removed password hint -->
      <span class="shortcut">M·ªü r·ªông C√°ch d√πng: <span class="kbd">Ctrl</span>+<span class="kbd">Shift</span>+<span class="kbd">U</span></span>
    </div>
    <div id="storageInfo"></div>
  </div>
</div>

<!-- Modal (only for Usage) -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true">
    <header>
      <div id="modalTitle">So·∫°n C√°ch d√πng</div>
      <button class="btn gray" onclick="closeEditor()">ƒê√≥ng</button>
    </header>
    <main>
      <textarea id="modalInput" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
      <div style="text-align:right; margin-top:6px; color:#64748b; font-size:12px;">
        <span id="modalCount">0</span> k√Ω t·ª±
      </div>
    </main>
    <footer>
      <button class="btn gray" onclick="closeEditor()">H·ªßy</button>
      <button class="btn update" onclick="applyEditor()">√Åp d·ª•ng</button>
    </footer>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  // ====== Version & storage
  const STORAGE_KEY='programs_v19_12c';
  const WIDTHS_KEY='programs_v19_12c_col_widths';
  const PASS_KEY='programs_v19_12c_admin_pass';
  const PREV_KEYS=['programs_v19_12b','programs_v19_12','programs_v19_11','programs_v19_10b','programs_v19_10','programs_v19_9'];

  // ====== Embedded default password
  const DEFAULT_ADMIN_PASS = 'voucher2025';

  // ====== State
  let rows = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
  if(!Array.isArray(rows) || rows.length===0){
    for(const k of PREV_KEYS){
      const v=localStorage.getItem(k);
      if(v){ try{ const t=JSON.parse(v); if(Array.isArray(t)){ rows=t; localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); break; } }catch(e){} }
    }
  }
  let editing=-1; let pickedImageDataURL=''; let q='';
  let ADMIN_PASS = localStorage.getItem(PASS_KEY) || '';
  let UNLOCKED = sessionStorage.getItem('programs_v19_12c_unlocked') === '1';

  // ====== Helpers
  function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(rows));updateStorageInfo();}
  function normalize(v){return(v||'').toString().toLowerCase();}
  function filteredRows(){if(!q)return rows;const k=normalize(q);return rows.filter(r=>[r.program,r.denom,r.symbol,r.usage,r.note].some(x=>normalize(x).includes(k)));}
  function isURL(s){ return /^https?:\/\/|^mailto:|^tel:/i.test(s||''); }
  function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

  // ====== Lock UI
  function refreshLockUI(){
    const table=document.getElementById('mainTable');
    if(!UNLOCKED) table.classList.add('locked-actions'); else table.classList.remove('locked-actions');
    document.getElementById('unlockBtn').disabled = UNLOCKED;
    document.getElementById('lockBtn').disabled = !UNLOCKED;
    document.getElementById('lockBox').style.background = UNLOCKED ? '#ecfeff' : '#f1f5f9';
  }
  function unlock(){
    const need = ADMIN_PASS || DEFAULT_ADMIN_PASS;
    const p = prompt('Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kh√≥a:');
    if(p===null) return;
    if(p===need){
      UNLOCKED=true; sessionStorage.setItem('programs_v19_12c_unlocked','1'); refreshLockUI(); alert('ƒê√£ m·ªü kh√≥a.');
    } else alert('Sai m·∫≠t kh·∫©u.');
  }
  function lock(){ UNLOCKED=false; sessionStorage.removeItem('programs_v19_12c_unlocked'); refreshLockUI(); }

  // ====== Password management
  function setAdminPass(){
    if(!UNLOCKED){ alert('Vui l√≤ng m·ªü kh√≥a tr∆∞·ªõc khi ƒë·ªïi m·∫≠t kh·∫©u.'); return; }
    const currentNeed = ADMIN_PASS || DEFAULT_ADMIN_PASS;
    const cur = prompt('Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i:');
    if(cur===null) return;
    if(cur !== currentNeed){ alert('Sai m·∫≠t kh·∫©u hi·ªán t·∫°i.'); return; }
    const a = prompt('Nh·∫≠p m·∫≠t kh·∫©u m·ªõi:');
    if(a===null) return;
    if(!a.trim()){ alert('M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.'); return; }
    const b = prompt('Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi:');
    if(b===null) return;
    if(a !== b){ alert('Hai l·∫ßn nh·∫≠p kh√¥ng kh·ªõp!'); return; }
    ADMIN_PASS = a;
    localStorage.setItem(PASS_KEY, ADMIN_PASS);
    alert('ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!');
  }

  // ====== Render
  function render(){
    const tb=document.getElementById('tbody');tb.innerHTML='';
    const fr=filteredRows();
    fr.forEach((r,i)=>{
      const href=r.img||'';
      const note = r.note||'';
      tb.innerHTML+=`
        <tr>
          <td>${i+1}</td>
          <td class="img-cell">${href?`<a class="cam" href="${href}" target="_blank" rel="noopener" title="M·ªü ·∫£nh">üì∑</a>`:''}</td>
          <td>${esc(r.program)}</td>
          <td>${esc(r.denom)}</td>
          <td>${esc(r.symbol)}</td>
          <td class="preline">${esc(r.usage)}</td>
          <td class="preline">${ isURL(note) ? `<a class="book" href="${note}" target="_blank" rel="noopener" title="M·ªü ghi ch√∫ (link)">üìñ</a>` : esc(note) }</td>
          <td class="actions">
            <button class="edit" onclick="onEdit(${rows.indexOf(r)})" title="S·ª≠a (c·∫ßn m·ªü kh√≥a)">‚úèÔ∏è</button>
            <button class="del" onclick="onDelete(${rows.indexOf(r)})" title="X√≥a (c·∫ßn m·ªü kh√≥a)">üóëÔ∏è</button>
          </td>
        </tr>`;
    });
    document.getElementById('countInfo').innerText=`Hi·ªÉn th·ªã ${fr.length} / ${rows.length} m·ª•c`;
    updateStorageInfo();
    refreshLockUI();
  }

  // ====== CRUD
  function guard(){ if(!UNLOCKED){ alert('T√≠nh nƒÉng n√†y ƒëang kh√≥a. B·∫•m üîê v√† nh·∫≠p m·∫≠t kh·∫©u.'); return false; } return true; }
  function addItem(){
    const imgUrl=document.getElementById('imgUrl').value.trim();
    const program=document.getElementById('program').value.trim();
    const denom=document.getElementById('denom').value.trim();
    const symbol=document.getElementById('symbol').value.trim();
    const usage=document.getElementById('usage').value.trim();
    const note=document.getElementById('note').value.trim();
    if(!program)return alert('Vui l√≤ng nh·∫≠p T√™n ch∆∞∆°ng tr√¨nh');
    const img=pickedImageDataURL||imgUrl;
    if(editing===-1) rows.push({img,program,denom,symbol,usage,note});
    else { rows[editing]={img,program,denom,symbol,usage,note}; editing=-1; setAddMode(); }
    save(); render(); resetFormFieldsOnly();
  }
  function onEdit(i){
    if(!guard()) return;
    const r=rows[i]; if(!r) return;
    document.getElementById('imgUrl').value='';
    document.getElementById('program').value=r.program||'';
    document.getElementById('denom').value=r.denom||'';
    document.getElementById('symbol').value=r.symbol||'';
    document.getElementById('usage').value=r.usage||'';
    document.getElementById('note').value=r.note||'';
    if((r.img||'').startsWith('data:image')){ pickedImageDataURL=r.img; } else { pickedImageDataURL=''; document.getElementById('imgUrl').value=r.img||''; }
    editing=i; setUpdateMode();
  }
  function onDelete(i){
    if(!guard()) return;
    if(!confirm('X√≥a m·ª•c n√†y?')) return;
    rows.splice(i,1); save(); render();
    if(editing===i){ editing=-1; setAddMode(); resetFormFieldsOnly(); }
  }
  function onClearAll(){
    if(!guard()) return;
    if(!confirm('X√≥a to√†n b·ªô d·ªØ li·ªáu?')) return;
    rows=[]; save(); render(); editing=-1; setAddMode(); resetFormFieldsOnly();
  }

  function resetFormFieldsOnly(){
    ['imgUrl','program','denom','symbol','usage','note'].forEach(id=>document.getElementById(id).value='');
  }

  function setAddMode(){ const btn = document.getElementById('addBtn'); btn.textContent='Th√™m'; btn.title='Th√™m'; btn.classList.remove('update'); btn.classList.add('add'); }
  function setUpdateMode(){ const btn = document.getElementById('addBtn'); btn.textContent='C·∫≠p nh·∫≠t'; btn.title='C·∫≠p nh·∫≠t m·ª•c ƒëang s·ª≠a'; btn.classList.remove('add'); btn.classList.add('update'); }

  // ====== Excel
  function exportExcel(){
    if(typeof XLSX==='undefined')return alert('Ch∆∞a s·∫µn s√†ng th∆∞ vi·ªán Excel');
    const wb=XLSX.utils.book_new();
    const src=filteredRows();
    const aoa=[['H√¨nh ·∫£nh','T√™n CT','M·ªánh gi√°','K√Ω hi·ªáu','C√°ch d√πng','Ghi ch√∫ (URL ho·∫∑c vƒÉn b·∫£n)'],...src.map(r=>[r.img||'',r.program||'',r.denom||'',r.symbol||'',r.usage||'',r.note||''])];
    const ws=XLSX.utils.aoa_to_sheet(aoa);XLSX.utils.book_append_sheet(wb,ws,'Programs');XLSX.writeFile(wb,'programs_v19_12c.xlsx');
  }
  function downloadExcelTemplate(){
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.aoa_to_sheet([
      ['H√¨nh ·∫£nh','T√™n CT','M·ªánh gi√°','K√Ω hi·ªáu','C√°ch d√πng','Ghi ch√∫ (URL ho·∫∑c vƒÉn b·∫£n)'],
      ['https://img.jpg','CT m·∫´u','100k','CT100K','H∆∞·ªõng d·∫´n nhi·ªÅu d√≤ng...','https://example.com/huong-dan']
    ]);
    XLSX.utils.book_append_sheet(wb,ws,'Template');XLSX.writeFile(wb,'template_v19_12c.xlsx');
  }
  function importExcel(ev){
    const f=ev.target.files[0];if(!f)return;const reader=new FileReader();
    reader.onload=e=>{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];const arr=XLSX.utils.sheet_to_json(ws,{header:1});
      arr.slice(1).forEach(row=>{ if(row[1])rows.push({img:row[0]||'',program:row[1]||'',denom:row[2]||'',symbol:row[3]||'',usage:row[4]||'',note:row[5]||''}); });
      save(); render();
    };
    reader.readAsArrayBuffer(f);
  }

  // ====== Misc
  function onSearchInput(val){q=val||'';render();}
  const usageEl=document.getElementById('usage'), usageCountEl=document.getElementById('usageCount');
  function autoResizeUsage(){ usageEl.style.height='auto'; usageEl.style.height=Math.min(usageEl.scrollHeight,220)+'px'; usageCountEl.textContent=(usageEl.value||'').length; }
  usageEl.addEventListener('input', autoResizeUsage); window.addEventListener('load', autoResizeUsage);

  function updateStorageInfo(){
    const el=document.getElementById('storageInfo');
    try{ const used=(JSON.stringify(localStorage).length)*2; const quota=5*1024*1024; const pct=Math.min(100,Math.round((used/quota)*100)); el.innerHTML=`<span class="${pct>85?'pill danger':'pill'}">LocalStorage: ${used} bytes / 5 MB (${pct}%)</span>`; }catch(e){ el.textContent=''; }
  }

  function setupResizers(){
    const table = document.getElementById('mainTable');
    const headCells = table.tHead.rows[0].cells;
    const colgroup = document.getElementById('cg');
    const cols = colgroup.children;
    cols[0].style.width = '40px';
    const saved = JSON.parse(localStorage.getItem(WIDTHS_KEY) || '[]');
    if(saved.length === cols.length){ saved.forEach((w,i)=>{ if(i!==0 && w) cols[i].style.width = w; }); }
    for(let i=0;i<headCells.length;i++){
      const th = headCells[i];
      if(i===0){ th.classList.add('locked'); continue; }
      const handle = document.createElement('span'); handle.className = 'col-resizer'; handle.title = 'K√©o ƒë·ªÉ thay ƒë·ªïi ƒë·ªô r·ªông c·ªôt'; th.appendChild(handle);
      let startX=0, startWidth=0; const minWidth=60;
      function onMouseDown(e){ startX=e.clientX; startWidth=parseInt(getComputedStyle(cols[i]).width,10); document.body.style.cursor='col-resize'; document.addEventListener('mousemove',onMouseMove); document.addEventListener('mouseup',onMouseUp); }
      function onMouseMove(e){ const dx=e.clientX-startX; const newW=Math.max(minWidth,startWidth+dx); cols[i].style.width=newW+'px'; }
      function onMouseUp(){ document.body.style.cursor=''; document.removeEventListener('mousemove',onMouseMove); document.removeEventListener('mouseup',onMouseUp); const widths=Array.from(cols).map((c,idx)=> idx===0 ? '40px' : (c.style.width||getComputedStyle(c).width)); localStorage.setItem(WIDTHS_KEY, JSON.stringify(widths)); }
      handle.addEventListener('mousedown', onMouseDown);
      handle.addEventListener('dblclick', ()=>{ const tmp=document.createElement('span'); tmp.style.visibility='hidden'; tmp.style.whiteSpace='nowrap'; tmp.textContent=th.textContent+'            '; document.body.appendChild(tmp); const w=Math.max(minWidth,tmp.getBoundingClientRect().width); document.body.removeChild(tmp); cols[i].style.width=Math.ceil(w)+'px'; const widths=Array.from(cols).map((c,idx)=> idx===0 ? '40px' : (c.style.width||getComputedStyle(c).width)); localStorage.setItem(WIDTHS_KEY, JSON.stringify(widths)); });
    }
  }

  // ====== Hotkeys
  window.addEventListener('keydown', (e)=>{
    if(e.ctrlKey && e.altKey && (e.key==='p' || e.key==='P')){ e.preventDefault(); setAdminPass(); }
    if(e.ctrlKey && e.shiftKey && (e.key==='u' || e.key==='U')){ e.preventDefault(); openEditor('usage'); }
    if(e.key==='Escape' && modal.classList.contains('show')){ e.preventDefault(); closeEditor(); }
  });
  document.getElementById('title').addEventListener('dblclick', ()=> setAdminPass() );

  // ====== Modal (Usage only)
  let currentField = null;
  const modal = document.getElementById('modal');
  const modalInput = document.getElementById('modalInput');
  const modalTitle = document.getElementById('modalTitle');
  const modalCount = document.getElementById('modalCount');
  function openEditor(field){ currentField = field; modalTitle.textContent = 'So·∫°n ' + (field === 'usage' ? 'C√°ch d√πng' : field); modalInput.value = document.getElementById(field).value || ''; modalCount.textContent = modalInput.value.length; modal.classList.add('show'); modalInput.focus(); }
  function closeEditor(){ modal.classList.remove('show'); currentField = null; }
  function applyEditor(){ if(!currentField){ closeEditor(); return; } document.getElementById(currentField).value = modalInput.value; if(currentField==='usage'){ autoResizeUsage(); } closeEditor(); }

  // ====== Init
  window.addEventListener('load', setupResizers);
  window.addEventListener('load', setAddMode);
  render();
</script>
</body>
</html>
